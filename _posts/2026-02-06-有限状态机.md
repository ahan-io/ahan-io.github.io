---
layout: post
title: "æœ‰é™çŠ¶æ€æœºå®è·µç»éªŒï¼ˆé™„ Golang ç¤ºä¾‹ï¼‰"
author: "Ahan"
date: 2026-02-06 00:00:00
header-img: "img/post-bg-2015.jpg"
header-style: text
catalog:      true
tags:
    - Architecture
    - Stability
    - å¼€å‘èŒƒå¼
---
åœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œ**å›´ç»•æŸä¸€ç±»èµ„æºæ„å»ºçŠ¶æ€æœºå¹¶é©±åŠ¨å…¶æµè½¬**å‡ ä¹æ˜¯ä¸å¯é¿å…çš„è®¾è®¡é€‰æ‹©ã€‚å…¶æ ¸å¿ƒç›®æ ‡é€šå¸¸åŒ…æ‹¬ï¼š

- é€šè¿‡çŠ¶æ€æœºï¼Œæ˜ç¡®èµ„æºåœ¨ä¸åŒé˜¶æ®µ**å…è®¸çš„æ“ä½œé›†åˆ**
- åœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œé€šè¿‡çŠ¶æ€çº¦æŸæ¥ä¿éšœ**ä¸šåŠ¡ä¸€è‡´æ€§**
- ä»¥å£°æ˜å¼çš„æ–¹å¼æè¿°ç›®æ ‡çŠ¶æ€ï¼Œç”±ç³»ç»Ÿè´Ÿè´£æ¨åŠ¨èµ„æº**æœ€ç»ˆæ”¶æ•›åˆ°æœŸæœ›çŠ¶æ€**

ä½†å³ä¾¿æ˜¯æœ‰åå¹´ä»¥ä¸Šç»éªŒçš„å·¥ç¨‹å¸ˆï¼Œåœ¨çŠ¶æ€æœºè®¾è®¡å’Œè½åœ°å®è·µä¸­ä¹Ÿä»ç„¶**éå¸¸å®¹æ˜“è¸©å‘**ã€‚å¸¸è§é—®é¢˜åŒ…æ‹¬ä½†ä¸é™äºï¼š

- çŠ¶æ€å˜æ›´æ—¶ï¼Œæœªé€šè¿‡ CAS æˆ–ç­‰ä»·æœºåˆ¶ä¿è¯åŸå­æ€§ï¼Œå¯¼è‡´å¹¶å‘æ›´æ–°ä¸‹å‡ºç°çŠ¶æ€å›é€€æˆ–è¦†ç›–ã€‚
- çŠ¶æ€å˜æ›´æ—¶ï¼Œæ²¡æœ‰æ ¡éªŒå‰ç½®çŠ¶æ€ï¼Œæœ€ç»ˆä½¿å¾—çŠ¶æ€æœºçš„å®é™…æµè½¬è·¯å¾„åç¦»è®¾è®¡é¢„æœŸï¼Œç”šè‡³è¿›å…¥ä¸å¯æ¢å¤çš„å¼‚å¸¸çŠ¶æ€ã€‚

ç»“åˆå®é™…ä»£ç å®è·µï¼Œæœ‰å‡ ç‚¹ç»éªŒå€¼å¾—ç‰¹åˆ«å¼ºè°ƒï¼š

- çŠ¶æ€æœºçš„æ•´ä½“æµè½¬è®¾è®¡ï¼Œ**æœ€å¥½æœ‰ä¸€ä»½ç‹¬ç«‹çš„æ–‡æ¡£è¿›è¡Œè¯´æ˜**ï¼Œå¹¶åœ¨ä»£ç ä¸­ç›´æ¥é™„ä¸Šæ–‡æ¡£é“¾æ¥ï¼Œé™ä½ç†è§£å’Œç»´æŠ¤æˆæœ¬ã€‚
- å¯¹äºéœ€è¦è¾ƒé•¿åˆå§‹åŒ–è¿‡ç¨‹çš„èµ„æºï¼ˆä¾‹å¦‚åˆ›å»º ECS å®ä¾‹ï¼‰ï¼Œåº”æ˜¾å¼å¼•å…¥â€œåˆ›å»ºä¸­â€çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç›´æ¥ä»â€œä¸å­˜åœ¨â€è·³è½¬åˆ°â€œå¯ç”¨â€ã€‚
- å¯¹äºéœ€è¦é‡Šæ”¾æˆ–å›æ”¶çš„èµ„æºï¼Œåº”å½“å¼•å…¥æ˜ç¡®çš„â€œåˆ é™¤ä¸­â€çŠ¶æ€ã€‚è¯¥çŠ¶æ€çš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼šå½“èµ„æºå¤„äºåˆ é™¤æµç¨‹ä¸­æ—¶ï¼Œå¯ä»¥**æœ‰æ•ˆé˜»æ–­ä¸€ç³»åˆ—ä¸åˆç†æˆ–å±é™©çš„æ“ä½œ**ã€‚
- çŠ¶æ€è½¬æ¢çš„è§„åˆ™ä¸åˆ¤æ–­é€»è¾‘ï¼Œ**åº”é›†ä¸­æ”¾åœ¨ä¸€ä¸ªç»Ÿä¸€çš„ä½ç½®**ï¼ˆæœ€å¥½æ˜¯ä¸€ä¸ªæ˜ç¡®çš„æ¨¡å—æˆ–å‡½æ•°ï¼‰ï¼Œè€Œä¸æ˜¯é›¶æ•£åˆ†å¸ƒåœ¨å„ä¸ªä¸šåŠ¡åˆ†æ”¯ä¸­ï¼Œä»¥é¿å…åæœŸæ¼”åŒ–å¤±æ§ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ª Golang çš„ç¤ºä¾‹ï¼š

```rust
package main

import (
	"context"
	"fmt"
	"sync"
	"time"
)

// ================= ç±»å‹å®šä¹‰ =================

type State string

const (
	StateCreating State = "Creating"
	StateRunning  State = "Running"
	StateDeleting State = "Deleting"
	StateFailed   State = "Failed"
	StateUnknown  State = "Unknown"
)

// Resource ä»£è¡¨æˆ‘ä»¬è¦ç®¡æ§çš„èµ„æº
type Resource struct {
	ID        string
	Status    State
	UpdatedAt time.Time
}

// ================= æ¨¡æ‹Ÿæ•°æ®åº“ (Store) =================

type MockDB struct {
	sync.RWMutex
	data map[string]*Resource
}

func (db *MockDB) GetAll() []*Resource {
	db.RLock()
	defer db.RUnlock()
	res := make([]*Resource, 0, len(db.data))
	for _, v := range db.data {
		res = append(res, v)
	}
	return res
}

func (db *MockDB) UpdateStatus(id string, status State) {
	db.Lock()
	defer db.Unlock()
	// TODO åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œè¿˜éœ€è¦åˆ¤æ–­å‰ç½®çŠ¶æ€æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå³çŠ¶æ€æœºçš„æµè½¬æ˜¯å¦æ˜¯åˆç†çš„ã€‚
	if r, ok := db.data[id]; ok {
		r.Status = status
		r.UpdatedAt = time.Now()
		fmt.Printf("[DB] Resource %s status updated to %s\n", id, status)
	}
}

// ================= æ§åˆ¶å™¨ (Controller) =================

type workerEntry struct {
	state  State
	cancel context.CancelFunc
}

type Controller struct {
	db       *MockDB
	notifyCh chan string   // ç”¨äºæ¥æ”¶å¤–éƒ¨é€šçŸ¥çš„ Channel
	interval time.Duration // è½®è¯¢å‘¨æœŸ
	mu       sync.Mutex
	workers  map[string]*workerEntry
}

func NewController(db *MockDB) *Controller {
	return &Controller{
		db:       db,
		notifyCh: make(chan string, 10),
		interval: 5 * time.Second,
		workers:  make(map[string]*workerEntry),
	}
}

func needAsync(state State) bool {
	switch state {
	case StateCreating, StateDeleting:
		return true
	default:
		return false
	}
}

// Notify å¤–éƒ¨è°ƒç”¨ï¼Œé€šçŸ¥ Controller æŸä¸ªèµ„æºå˜äº†
func (c *Controller) Notify(id string) {
	c.notifyCh <- id
}

// Run å¯åŠ¨æ§åˆ¶å™¨
func (c *Controller) Run(ctx context.Context) {
	fmt.Println("ğŸš€ Controller started...")

	// å¯åŠ¨å‘¨æœŸæ€§æ‰«æ
	ticker := time.NewTicker(c.interval)
	defer ticker.Stop()

	for {
		select {
		case <-ctx.Done():
			return
		case <-ticker.C:
			fmt.Println("ğŸ” Periodic scanning all resources...")
			c.reconcileAll(ctx)
		case id := <-c.notifyCh:
			fmt.Printf("âš¡ Event received for resource: %s\n", id)
			c.reconcileOne(ctx, id)
		}
	}
}

// reconcileAll æ‰«ææ‰€æœ‰èµ„æº
func (c *Controller) reconcileAll(ctx context.Context) {
	resources := c.db.GetAll()
	for _, r := range resources {
		c.processState(ctx, r)
	}
}

// reconcileOne å¤„ç†å•ä¸ªèµ„æº
func (c *Controller) reconcileOne(ctx context.Context, id string) {
	// å®é™…åœºæ™¯ä¸‹ä¼šä» DB æŸ¥å‡ºæœ€æ–°çŠ¶æ€
	c.db.RLock()
	r, ok := c.db.data[id]
	c.db.RUnlock()
	if ok {
		c.processState(ctx, r)
	}
}

// processState çŠ¶æ€æœºæ ¸å¿ƒé€»è¾‘ï¼šæ ¹æ®å½“å‰çŠ¶æ€æ‰§è¡Œé¢„æœŸæ“ä½œ
func (c *Controller) processState(ctx context.Context, r *Resource) {
	if needAsync(r.Status) {
		c.ensureWorker(ctx, r.ID, r.Status)
		return
	}

	switch r.Status {
	case StateRunning:
		fmt.Printf("ğŸŸ¢ Handling RUNNING for %s: Health checking...\n", r.ID)
		// å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå¯ä»¥è½¬ä¸º Failed

	case StateFailed:
		fmt.Printf("âŒ Handling FAILED for %s: Triggering alert or retry...\n", r.ID)

	default:
		fmt.Printf("â“ Unknown state for %s\n", r.ID)
	}
}

func (c *Controller) ensureWorker(ctx context.Context, id string, state State) {
	c.mu.Lock()
	defer c.mu.Unlock()

	if entry, ok := c.workers[id]; ok {
		if entry.state == state {
			fmt.Printf("â­ï¸  Worker already running for %s (%s)\n", id, state)
			return
		}

		// çŠ¶æ€å˜åŒ–ï¼Œå–æ¶ˆæ—§ worker
		// å¦‚æœå·²ç»èµ„æºå·²ç»æœ‰ä¸€ä¸ª worker æ­£åœ¨å¦å¤–ä¸€ä¸ªçŠ¶æ€ï¼Œä¸ºäº†é¿å…å†²çªï¼Œæˆ‘ä»¬è°ƒç”¨ cancel å°½åŠ›å–æ¶ˆåï¼Œç­‰å¾… worker ç»“æŸï¼Œä¸å¯åŠ¨æ–°çš„åç¨‹ã€‚
		fmt.Printf("ğŸ”„ State changed for %s: cancel %s worker\n", id, entry.state)
		entry.cancel()
		fmt.Printf("ğŸš§ Wait for the worker of %s, it is running for state %s\n", id, entry.state)
		return
	}

	ctx, cancel := context.WithCancel(ctx)
	c.workers[id] = &workerEntry{
		state:  state,
		cancel: cancel,
	}

	fmt.Printf("ğŸš§ Starting %s worker for %s\n", state, id)
	go c.resourceWorker(ctx, id, state)
}

func (c *Controller) resourceWorker(ctx context.Context, id string, state State) {
	defer func() {
		c.mu.Lock()
		delete(c.workers, id)
		c.mu.Unlock()
		fmt.Printf("ğŸ§¹ Worker for %s (%s) exited\n", id, state)
	}()

	switch state {

	case StateCreating:
		fmt.Printf("ğŸ› ï¸  Creating resource %s...\n", id)
		select {
		case <-time.After(4 * time.Second):
			c.db.UpdateStatus(id, StateRunning)
			fmt.Printf("âœ… Resource %s created\n", id)

		case <-ctx.Done():
			fmt.Printf("âš ï¸  Creating worker for %s canceled\n", id)
			return
		}

	case StateDeleting:
		fmt.Printf("ğŸ—‘ï¸  Deleting resource %s...\n", id)
		select {
		case <-time.After(5 * time.Second):
			c.db.Lock()
			delete(c.db.data, id)
			c.db.Unlock()
			fmt.Printf("âœ… Resource %s deleted\n", id)

		case <-ctx.Done():
			fmt.Printf("âš ï¸  Deleting worker for %s canceled\n", id)
			return
		}
	}
}

// ================= å…¥å£å‡½æ•° =================

func main() {
	// 1. åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ®
	db := &MockDB{
		data: map[string]*Resource{
			"res-1": {ID: "res-1", Status: StateCreating, UpdatedAt: time.Now()},
			"res-2": {ID: "res-2", Status: StateRunning, UpdatedAt: time.Now()},
			"res-3": {ID: "res-3", Status: StateCreating, UpdatedAt: time.Now()},
		},
	}

	// 2. åˆå§‹åŒ–æ§åˆ¶å™¨
	ctrl := NewController(db)
	ctx, cancel := context.WithCancel(context.Background())
	defer cancel()

	// 3. å¼‚æ­¥å¯åŠ¨æ§åˆ¶å™¨
	go ctrl.Run(ctx)

	// 4. æ¨¡æ‹Ÿå¤–éƒ¨å¹²é¢„
	time.Sleep(2 * time.Second)
	fmt.Println("\n--- External User action: Delete res-2 ---")
	db.UpdateStatus("res-2", StateDeleting)
	ctrl.Notify("res-2") // ç«‹å³é€šçŸ¥æ§åˆ¶å™¨ï¼Œä¸ç”¨ç­‰ä¸‹ä¸ª 5s å‘¨æœŸ
	time.Sleep(20 * time.Second)
	db.UpdateStatus("res-3", StateDeleting)
	ctrl.Notify("res-3") // ç«‹å³é€šçŸ¥æ§åˆ¶å™¨ï¼Œä¸ç”¨ç­‰ä¸‹ä¸ª 5s å‘¨æœŸ

	// è®©ç¨‹åºè¿è¡Œä¸€æ®µæ—¶é—´è§‚å¯Ÿè¾“å‡º
	time.Sleep(60 * time.Second)
	fmt.Println("Terminating demo...")
}

```

æ”¾åœ¨ main.go é‡Œï¼Œç›´æ¥ go run main.go å°±å¯ä»¥è·‘ã€‚